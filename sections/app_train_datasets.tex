%\begin{comment}
\begin{table*}
\small
\centering
\setlength{\tabcolsep}{3.5pt}
\begin{tabular}{lrrrrrrrrr}
\toprule
\textbf{Dataset} & \textbf{\ctrltag{negation}} & \textbf{\ctrltag{quantifier}} & \textbf{\ctrltag{leixcal}} & \textbf{\ctrltag{resemantic}} & \textbf{\ctrltag{insert}} & \textbf{\ctrltag{delete}} & \textbf{\ctrltag{restructure}} & \textbf{\ctrltag{shuffle}} & \emph{\ctrltag{global}} \\ 
\midrule
        CAD &      3456 &         457 &    10650 &        4634 &    2169 &    2162 &          234 &       84 &    3756 \\
    Crawled &         0 &           0 &     5000 &           0 &    5000 &    5000 &            0 &      108 &    5000 \\
   contrast &       336 &         436 &     1607 &        1291 &     589 &     586 &          275 &      149 &     877 \\
       hans &        50 &           0 &        0 &           0 &    3926 &    3926 &          494 &     1602 &       2 \\
    paranmt &      2797 &         825 &    10000 &       10000 &    6442 &    6205 &         5136 &     1417 &   10000 \\
       paws &        81 &        1815 &    10000 &       10000 &    3630 &    3403 &         4551 &    10000 &   10000 \\
 winogrande &      3011 &          94 &    10000 &        6927 &     120 &     124 &          453 &       65 &    3184 \\
      total &      9731 &        3627 &    47257 &       32852 &   21876 &   21406 &        11143 &    13425 &   32819 \\
\bottomrule
\vspace{-10pt}
\end{tabular}
\caption{The datasets used for finetuning the GPT-2 perturbation model, and the \tagstr distributions.}
\label{table:gpt_train_stats}
\end{table*}
%\end{comment}

\section{GPT-2 as Counterfactual Generator}
\label{appendix:train_data}

\subsection{Training data collection}


We combined the following NLP datasets in finetuning our GPT-2 perturbation model.
To achieve a more balanced distribution, for each dataset, we extract \tagstrs from all the data pairs available, and randomly sample up to 10k instances per \tagstr.
The distribution is shown in Table~\ref{table:gpt_train_stats}.

\paragraph{Contrast set}
In \cite{gardner2020contrast}, authors of 10 existing NLP dataset each manually perturbed 100-1,000 test instances in small but meaningful ways that change the gold label, so to inspect a model's decision boundary around a local instance.
\wts{Make sure NLP is expanded somewhere in intro}
The perturbation pattern varies based on the tasks and the annotators, allowing us to learn diverse perturbation methods.
To make sure we can use the contrast set to evaluate the sentiment analysis model, we excluded the IMDB movie review from the training.
\footnote{Similarly, though QQP would be a potentially interesting dataset for training the perturbation model, we omitted it so QQP can be used in our evaluation.}
%\wts{Re-train the model with other contrast sets.}


\paragraph{Counterfactually-augmented data (CAD)}
To augment the training data, \citet{kaushik2019learning} crowdsourced counterfactual perturbations for IMDB movie review (1.7k perturbations on 1.7k original instances) and SNLI (6.6k perturbations on 1.67k original instances).
Similar to contrast set, the perturbation patterns vary based on the task, but can especially contribute to \ctrltag{negation}.
We split the movie review paragraphs into paired sentences, to match the sentence length of other datasets.


\paragraph{WINOGRANDE} is a large-scale dataset of 44k problems for testing common sense problems~\cite{sakaguchi2019winogrande}.
The dataset contains nearly identical sentences that differ only by one trigger word, which flips the correct answer choice for certain questions.
The dataset is most suitable for lexical tokens that are suitable for similar use cases.

\paragraph{ParaNMT-50M} contains 50 million English-English sentential paraphrase pairs, covering various domains and styles of text, as well as different sentence structures~\citet{wieting2017paranmt}. 

\paragraph{PAWS} contains paraphrase and non-paraphrase pairs with high lexical overlap. 
\citet{zhang2019paws} created 108k challenging pairs by controlled word swapping and back translation.
As a result, the dataset demonstrates the \ctrltag{shuffle} and \ctrltag{restructure} strategy.


\paragraph{HANS} is a controlled evaluation dataset designed for testing decision boundaries of NLI models~\cite{mccoy2019right}. 
The dataset contains 10k pairs of premises and hypotheses created based on 10 heavily on fallible syntactic heuristic rules, and therefore compensates rarer structural changes that may be missed by PAWS.


\paragraph{Crawled} 
We additionally crawled some sentence pairs from non-paired datasets like SQuAD~\cite{rajpurkar-etal-2016-squad} to boost some specific patterns and increase lexical diversity. 
We estimated \emph{close} pairs (D1) using edit distance, but noticed that it inevitably paired up some unrelated examples (\eg \exinline{how do I not be} and \exinline{how do I recover it} are incorrectly considered \ctrltag{negation} pairs.)
We only included them for the most determined patterns, \ie \ctrltag{lexical}, \ctrltag{insert}, \ctrltag{delete}, and \ctrltag{shuffle}.


\subsection{Training Prompts \& Parameters}

Given a pair, we use the two sentences interchangeably as $x$ and $\xp$ to learn the perturbations both ways.
We compute its primary \tagstr based on linguistic features like part-of-speech tagging or dependency trees, and blank out the changed subphrases in $\xp$.
For example, \ctrltag{negation} occurs when we observe changes on negation modifiers or specific words like ``supposedly'', and \ctrltag{shuffle} occurs when we have overlaps between tokens deleted and added.
When multiple changes occur, we label it with the primary \tagstr, which most significantly change the semantic meaning on the corresponding subphrase.
In Figure~\ref{fig:blank}, we use the tag \ctrltag{negation}, as \swap{great}{not great} is more significant than \swap{kids}{children}.
If we cannot identify the \tagstr for a pair or if the editing distance is too large, we denote it with \ctrltag{[global]} and use them as negative samples.
Importantly, to allow flexible blanking at the generation time, instead of merely blanking the edited spans, we also extend the blank to cover their associated parsing structures, etc.
As a result, we form up to four unique training prompts given one $(x, \xp)$ pair (Figure~\ref{fig:blank}).

%max_log_prob_diff

With the interchangeable orders and the blanks, we generate 657,144 training prompts from 191,415 sentence pairs.
We use the data to finetune an off-the-shelf GPT-2 model (from \citet{Wolf2019HuggingFacesTS}), but any LM can potentially be used.
%\wts{Add the training hyperparameters; And maybe eventually move them to appendix.}
We finetuned the model for 3 epochs, with an initial learning rate 5e-5, a batch size of 16 and a sequence length of 120.